<div class="container">
  <div class="header">
    <button
      pButton
      type="button"
      icon="pi pi-arrow-left"
      (click)="goBack()"
      class="p-button-text p-button-secondary back-button">
    </button>
    <div>
      <h1>Combined Form Demo</h1>
      <p class="subtitle">Lazy-loaded dropdowns with radio buttons and data table</p>
      <p class="user-info">User ID: <strong>{{ userId }}</strong></p>
    </div>
  </div>

  <!-- Initial Loading -->
  <div *ngIf="initialLoading" class="loading-container">
    <i class="pi pi-spin pi-spinner loading-spinner-large"></i>
    <p>Loading your preferences...</p>
  </div>

  <div *ngIf="!initialLoading">
    <div class="form-section">
      <!-- Category Dropdown -->
      <div class="field">
        <label for="category">Category</label>
        <div class="dropdown-wrapper">
          <p-dropdown
            id="category"
            [options]="categoryOptions"
            [(ngModel)]="selectedCategory"
            (onFocus)="onCategoryFocus()"
            (onChange)="onCategoryChange()"
            [disabled]="formLocked"
            [placeholder]="categoryLoading ? 'Loading...' : 'Select a Category'"
            [style]="{'width': '100%'}"
            [showClear]="true">
          </p-dropdown>
          <i *ngIf="categoryLoading" class="pi pi-spin pi-spinner loading-spinner"></i>
        </div>
      </div>

      <!-- Subcategory Dropdown -->
      <div class="field">
        <label for="subcategory">Subcategory</label>
        <div class="dropdown-wrapper">
          <p-dropdown
            id="subcategory"
            [options]="subcategoryOptions"
            [(ngModel)]="selectedSubcategory"
            (onFocus)="onSubcategoryFocus()"
            (onChange)="onSubcategoryChange()"
            [disabled]="formLocked || !selectedCategory"
            [placeholder]="subcategoryLoading ? 'Loading...' : 'Select a Subcategory'"
            [style]="{'width': '100%'}"
            [showClear]="true">
          </p-dropdown>
          <i *ngIf="subcategoryLoading" class="pi pi-spin pi-spinner loading-spinner"></i>
        </div>
        <small *ngIf="!selectedCategory" class="hint">Please select a category first</small>
      </div>

      <!-- Status Dropdown -->
      <div class="field">
        <label for="status">Status</label>
        <div class="dropdown-wrapper">
          <p-dropdown
            id="status"
            [options]="statusOptions"
            [(ngModel)]="selectedStatus"
            (onFocus)="onStatusFocus()"
            (onChange)="onStatusChange()"
            [disabled]="formLocked"
            [placeholder]="statusLoading ? 'Loading...' : 'Select a Status'"
            [style]="{'width': '100%'}"
            [showClear]="true">
          </p-dropdown>
          <i *ngIf="statusLoading" class="pi pi-spin pi-spinner loading-spinner"></i>
        </div>
      </div>

      <!-- Department Dropdown -->
      <div class="field">
        <label for="department">Department</label>
        <div class="dropdown-wrapper">
          <p-dropdown
            id="department"
            [options]="departmentOptions"
            [(ngModel)]="selectedDepartment"
            (onFocus)="onDepartmentFocus()"
            (onChange)="onDepartmentChange()"
            [disabled]="formLocked"
            [placeholder]="departmentLoading ? 'Loading...' : 'Select Department'"
            [style]="{'width': '100%'}"
            [showClear]="true">
          </p-dropdown>
          <i *ngIf="departmentLoading" class="pi pi-spin pi-spinner loading-spinner"></i>
        </div>
      </div>

      <!-- Region Dropdown -->
      <div class="field">
        <label for="region">Region</label>
        <div class="dropdown-wrapper">
          <p-dropdown
            id="region"
            [options]="regionOptions"
            [(ngModel)]="selectedRegion"
            (onFocus)="onRegionFocus()"
            (onChange)="onRegionChange()"
            [disabled]="formLocked"
            [placeholder]="regionLoading ? 'Loading...' : 'Select Region'"
            [style]="{'width': '100%'}"
            [showClear]="true">
          </p-dropdown>
          <i *ngIf="regionLoading" class="pi pi-spin pi-spinner loading-spinner"></i>
        </div>
      </div>

      <!-- Type Dropdown -->
      <div class="field">
        <label for="type">Type</label>
        <div class="dropdown-wrapper">
          <p-dropdown
            id="type"
            [options]="typeOptions"
            [(ngModel)]="selectedType"
            (onFocus)="onTypeFocus()"
            (onChange)="onTypeChange()"
            [disabled]="formLocked"
            [placeholder]="typeLoading ? 'Loading...' : 'Select Type'"
            [style]="{'width': '100%'}"
            [showClear]="true">
          </p-dropdown>
          <i *ngIf="typeLoading" class="pi pi-spin pi-spinner loading-spinner"></i>
        </div>
      </div>

      <!-- Gender Dropdown -->
      <div class="field">
        <label for="gender">Gender</label>
        <div class="dropdown-wrapper">
          <p-dropdown
            id="gender"
            [options]="genderOptions"
            [(ngModel)]="selectedGender"
            (onFocus)="onGenderFocus()"
            (onChange)="onGenderChange()"
            [disabled]="formLocked"
            [placeholder]="genderLoading ? 'Loading...' : 'Select Gender'"
            [style]="{'width': '100%'}"
            [showClear]="true">
          </p-dropdown>
          <i *ngIf="genderLoading" class="pi pi-spin pi-spinner loading-spinner"></i>
        </div>
      </div>

      <hr class="field-divider">

      <!-- Main Radio Options (Option A / Option B) -->
      <div class="field">
        <label>Select Main Option</label>
        <div class="radio-group" *ngIf="mainOptionsLoaded">
          <div *ngFor="let option of mainOptions" class="radio-item">
            <p-radioButton
              [name]="'mainOption'"
              [value]="option"
              [(ngModel)]="selectedMainOption"
              (onClick)="onMainOptionChange()"
              [inputId]="option"
              [disabled]="formLocked">
            </p-radioButton>
            <label [for]="option" class="radio-label">{{ option }}</label>
          </div>
        </div>
        <div *ngIf="mainOptionsLoading" class="loading-text">
          <i class="pi pi-spin pi-spinner"></i> Loading options...
        </div>
        <small *ngIf="!mainOptionsLoaded && !mainOptionsLoading" class="hint">Loading options...</small>
      </div>

      <!-- Option A: Show 3 sub-radio buttons -->
      <div class="field" *ngIf="selectedMainOption === 'Option A'">
        <label>Select Sub Option</label>
        <div class="radio-group" *ngIf="subOptionsLoaded">
          <div *ngFor="let subOption of optionASubOptions" class="radio-item">
            <p-radioButton
              [name]="'subOption'"
              [value]="subOption"
              [(ngModel)]="selectedSubOption"
              (onClick)="onSubOptionChange()"
              [inputId]="subOption"
              [disabled]="formLocked">
            </p-radioButton>
            <label [for]="subOption" class="radio-label">{{ subOption }}</label>
          </div>
        </div>
        <div *ngIf="subOptionsLoading" class="loading-text">
          <i class="pi pi-spin pi-spinner"></i> Loading sub options...
        </div>
      </div>

      <!-- Option A: Dropdown based on sub-option selection -->
      <div class="field" *ngIf="selectedMainOption === 'Option A' && selectedSubOption">
        <label>Select Value (based on {{ selectedSubOption }})</label>
        <div class="dropdown-wrapper">
          <p-dropdown
            [options]="optionADropdownOptions"
            [(ngModel)]="selectedOptionADropdown"
            (onFocus)="onOptionADropdownFocus()"
            [disabled]="formLocked"
            [placeholder]="optionADropdownLoading ? 'Loading...' : 'Select a value'"
            [style]="{'width': '100%'}"
            [showClear]="true">
          </p-dropdown>
          <i *ngIf="optionADropdownLoading" class="pi pi-spin pi-spinner loading-spinner"></i>
        </div>
      </div>

      <!-- Option B: Direct dropdown -->
      <div class="field" *ngIf="selectedMainOption === 'Option B'">
        <label>Select Month</label>
        <div class="dropdown-wrapper">
          <p-dropdown
            [options]="optionBDropdownOptions"
            [(ngModel)]="selectedOptionBDropdown"
            (onFocus)="onOptionBDropdownFocus()"
            [disabled]="formLocked"
            [placeholder]="optionBDropdownLoading ? 'Loading...' : 'Select a month'"
            [style]="{'width': '100%'}"
            [showClear]="true">
          </p-dropdown>
          <i *ngIf="optionBDropdownLoading" class="pi pi-spin pi-spinner loading-spinner"></i>
        </div>
      </div>

      <!-- Continue and Reset Buttons -->
      <div class="button-section">
        <button
          pButton
          type="button"
          label="Continue"
          (click)="onContinue()"
          [disabled]="!canContinue() || tableLoading || formLocked"
          class="p-button">
        </button>
        <button
          *ngIf="formLocked"
          pButton
          type="button"
          label="Reset"
          (click)="resetForm()"
          class="p-button-secondary reset-button">
        </button>
        <i *ngIf="tableLoading" class="pi pi-spin pi-spinner button-spinner"></i>
      </div>
    </div>

    <!-- Data Table -->
    <div class="table-section" *ngIf="showTable">
      <h2>Results</h2>

      <!-- Show query parameters -->
      <div class="query-params">
        <strong>Query Parameters:</strong>
        <span class="param">Category: {{ selectedCategory || 'Any' }}</span>
        <span class="param">Subcategory: {{ selectedSubcategory || 'Any' }}</span>
        <span class="param">Status: {{ selectedStatus || 'Any' }}</span>
        <span class="param" *ngIf="selectedMainOption">Main Option: {{ selectedMainOption }}</span>
        <span class="param" *ngIf="selectedMainOption === 'Option A' && selectedSubOption">Sub Option: {{ selectedSubOption }}</span>
        <span class="param" *ngIf="selectedMainOption === 'Option A' && selectedOptionADropdown">Value: {{ selectedOptionADropdown }}</span>
        <span class="param" *ngIf="selectedMainOption === 'Option B' && selectedOptionBDropdown">Month: {{ selectedOptionBDropdown }}</span>
      </div>

      <p-table [value]="tableData" [tableStyle]="{'min-width': '50rem'}">
        <ng-template pTemplate="header">
          <tr>
            <th>ID</th>
            <th>Name</th>
            <th>Category</th>
            <th>Subcategory</th>
            <th>Status</th>
            <th>Description</th>
          </tr>
        </ng-template>
        <ng-template pTemplate="body" let-item>
          <tr>
            <td>{{ item.id }}</td>
            <td>{{ item.name }}</td>
            <td>{{ item.category }}</td>
            <td>{{ item.subcategory }}</td>
            <td>
              <span [class]="'status-badge status-' + item.status.toLowerCase()">
                {{ item.status }}
              </span>
            </td>
            <td>{{ item.description }}</td>
          </tr>
        </ng-template>
        <ng-template pTemplate="emptymessage">
          <tr>
            <td colspan="6" class="empty-message">No data found matching your criteria.</td>
          </tr>
        </ng-template>
      </p-table>
    </div>
  </div>

  <!-- Error Modal -->
  <p-dialog
    header="Error"
    [(visible)]="showErrorModal"
    [modal]="true"
    [closable]="false"
    [style]="{width: '400px'}"
    [baseZIndex]="10000">
    <div class="error-modal-content">
      <i class="pi pi-exclamation-triangle error-icon"></i>
      <p class="error-message">{{ errorMessage }}</p>
    </div>
    <ng-template pTemplate="footer">
      <div class="error-modal-footer">
        <button pButton type="button" label="OK" (click)="closeErrorModal()" class="p-button-primary"></button>
      </div>
    </ng-template>
  </p-dialog>
</div>
